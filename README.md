
# HONPAS-DeepMD 数据构建流程 

本项目旨在实现 HONPAS 第一性原理计算到机器学习势函数训练集生成的自动化流程。目前已完成初始结构采样、任务调度、数据清洗及数据集分布分析模块的开发。

## 1. 项目概述

为了构建高精度的机器学习势能（MLP），本项目基于 Python 开发了一套自动化脚本，主要包含以下功能：
*   **结构采样**：基于基态结构生成超胞构型、微扰构型，用于扩充训练集的相空间覆盖度。
*   **接口适配**：自动生成 HONPAS 输入文件，支持单点能 (SCF)、结构优化 (Relax) 和分子动力学 (AIMD) 模式。
*   **流程管理**：对接 Slurm 集群进行作业提交与监控。
*   **数据清洗**：提取计算结果并进行物理合理性校验，剔除异常数据。
*   **质量评估**：基于 SOAP 描述符对数据集进行可视化分析。

## 2. 目录结构说明

```text
HAP_project_v2/
├── config.py              # 全局参数配置（微扰幅度、清洗阈值、路径设置）
├── main.py                # 主程序入口，通过命令行控制各阶段执行
├── modules/               # 功能模块
│   ├── sampler.py         # 结构超胞构建微扰生成与预筛选
│   ├── validator.py       # 几何检查模块（原子重叠检测）
│   ├── wrapper.py         # HONPAS 输入文件生成 (.fdf)
│   ├── scheduler.py       # 任务目录创建、赝势分发与 Slurm 提交
│   ├── extractor.py       # 计算结果解析 (log -> dpdata)
│   ├── cleaner.py         # 数据清洗 (能量/受力统计筛选)
│   ├── analyzer.py        # 数据集分布分析 (SOAP + PCA)
│   └── workflows.py       # 阶段流程逻辑封装
├── templates/             # 计算模板与赝势库
└── data/                  # 数据流转目录
    ├── raw/               # 原始输入 (POSCAR)
    ├── perturbed/         # 微扰结构备份
    ├── training/          # 最终生成的 DeepMD 训练集 (npy格式)
    └── analysis/          # 分析报告与图表
```

## 3. 已实现功能模块

### 3.1 初始采样 (Sampler & Validator)
*   **微扰生成**：利用 `dpdata` 对晶胞随机原子微扰和晶格形变。
*   **物理预筛选**：引入几何检查机制，在生成阶段自动剔除原子间距小于共价半径和 0.5 倍的结构，避免提交必定发散的计算任务。

### 3.2 任务调度 (Scheduler)
*   **模板适配**：支持通过 `config.py` 配置不同计算模式（SCF/Relax/AIMD）的输入模板。
*   **自动部署**：自动创建任务文件夹，写入输入文件并复制对应的赝势文件（`.psf`）。
*   **集群对接**：自动生成 Slurm 作业脚本并支持批量提交。

### 3.3 数据后处理 (Extractor & Cleaner)
*   **结果提取**：解析 HONPAS 输出日志，提取能量、力、维里（Virial）和坐标信息。
*   **质量控制 (QC)**：
    *   **几何校验**：二次检查计算后的结构是否存在原子重叠。
    *   **统计筛选**：计算能量分布的 Z-score，自动剔除偏离平均值超过阈值（如 $4\sigma$）的离群帧。
    *   **受力筛选**：剔除受力异常大（如 $> 30 \text{ eV/\AA}$）的发散帧。

### 3.4 数据分析 (Analyzer)
*   **相空间可视化**：计算结构的全局 SOAP 描述符，利用 PCA 降维并结合相对能量进行可视化。
*   **用途**：用于评估生成的微扰结构或 MD 轨迹是否具有足够的多样性，以及是否存在非物理的结构断层。

## 4. 当前工作流

通过 `main.py` 分三个阶段执行：

*   **Stage 1: 生成与提交**
    *   读取 `POSCAR` -> 生成微扰结构 -> 预筛选 -> 生成任务目录 -> 提交 Slurm 作业。
*   **Stage 2: 收集与清洗**
    *   遍历任务目录 -> 提取 `output.log` -> 执行 QC 清洗 -> 导出为 DeepMD (`.npy`) 格式。
*   **Stage 3: 分析与评估**
    *   读取清洗后的数据集 -> 计算 SOAP-PCA -> 生成分布图。

## 5. 依赖环境

*   Python 3.x
*   dpdata
*   ase
*   numpy
*   dscribe (用于 SOAP 计算)
*   scikit-learn (用于 PCA 降维)
*   matplotlib / seaborn